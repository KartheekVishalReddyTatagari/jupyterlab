# .github/workflows/grype.yaml
name: üì¶ DevSecOps - Dependency Scan (Grype SCA)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  grype_scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: ‚¨áÔ∏è Install Grype CLI
        # Install the Grype binary directly using the recommended script
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b $HOME/.local/bin
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          grype version # Verify installation and add to path
          
      - name: üîé Run Grype Scan and Suppress Failure
        # We run the command directly and use '|| true' to ensure the step exits successfully (exit code 0),
        # even if Grype finds vulnerabilities and returns a non-zero code.
        run: |
          grype dir:. -o json --file grype-report.json --fail-on high || true

      - name: üì§ Print Grype Report Content
        # The file is now guaranteed to exist and this step will run
        run: |
          echo "--- START GRYPE REPORT (Medium/High/Critical Findings) ---"
          cat grype-report.json
          echo "--- END GRYPE REPORT ---"
          
      - name: ‚¨ÜÔ∏è Upload Grype Report Artifact
        # The file is now guaranteed to exist and this step will run
        uses: actions/upload-artifact@v4
        with:
          name: grype-security-report
          path: grype-report.json